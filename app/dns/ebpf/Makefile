# DNS eBPF Accelerator Makefile

# ç¼–è¯‘å™¨è®¾ç½®
CC = clang
CFLAGS = -O2 -g -Wall -target bpf -c
INCLUDES = -I/usr/include/bpf -I/usr/include/x86_64-linux-gnu

# ç›®æ ‡æ–‡ä»¶
DNS_CACHE_TARGET = dns_cache.o
DNS_ACCELERATOR_TARGET = dns_accelerator.o
DNS_ACCELERATOR_SIMPLE_TARGET = dns_accelerator_simple.o
TARGETS = $(DNS_CACHE_TARGET) $(DNS_ACCELERATOR_TARGET) $(DNS_ACCELERATOR_SIMPLE_TARGET)

# æºæ–‡ä»¶
DNS_CACHE_SOURCES = dns_cache.c
DNS_ACCELERATOR_SOURCES = dns_accelerator.c
DNS_ACCELERATOR_SIMPLE_SOURCES = dns_accelerator_simple.c

# é»˜è®¤ç›®æ ‡
all: $(TARGETS)

# ç®€åŒ–ç‰ˆæœ¬ä¼˜å…ˆï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰
simple: $(DNS_CACHE_TARGET) $(DNS_ACCELERATOR_SIMPLE_TARGET)
	@echo "âœ… DNS eBPF programs (simple version) compiled successfully"

# ç¼–è¯‘åŸºç¡€DNSç¼“å­˜eBPFç¨‹åº
$(DNS_CACHE_TARGET): $(DNS_CACHE_SOURCES)
	$(CC) $(CFLAGS) $(INCLUDES) -o $@ $<
	@echo "âœ… DNS Cache eBPF program compiled successfully"

# ç¼–è¯‘é«˜çº§DNSåŠ é€Ÿå™¨eBPFç¨‹åº  
$(DNS_ACCELERATOR_TARGET): $(DNS_ACCELERATOR_SOURCES)
	$(CC) $(CFLAGS) $(INCLUDES) -o $@ $<
	@echo "âœ… DNS Accelerator eBPF program compiled successfully"

# ç¼–è¯‘ç®€åŒ–DNSåŠ é€Ÿå™¨eBPFç¨‹åºï¼ˆé¿å…æ ˆæº¢å‡ºï¼‰
$(DNS_ACCELERATOR_SIMPLE_TARGET): $(DNS_ACCELERATOR_SIMPLE_SOURCES)
	$(CC) $(CFLAGS) $(INCLUDES) -o $@ $<
	@echo "âœ… DNS Accelerator Simple eBPF program compiled successfully"

# ç”ŸæˆGoä»£ç ï¼ˆéœ€è¦bpf2goå·¥å…·ï¼‰
generate:
	@echo "ğŸ”§ Generating Go bindings..."
	bpf2go -cc clang -cflags "$(CFLAGS)" -target bpf \
		-type dns_cache_entry \
		-type dns_server_info \
		-type malicious_domain_entry \
		-type dns_query_stats \
		-type dns_perf_metrics \
		dns_cache ./$(DNS_CACHE_SOURCES)
	bpf2go -cc clang -cflags "$(CFLAGS)" -target bpf \
		-type dns_cache_entry \
		-type dns_server_info \
		-type malicious_domain_entry \
		-type dns_query_stats \
		-type dns_perf_metrics \
		-type dns_query_request \
		dns_accelerator ./$(DNS_ACCELERATOR_SOURCES)
	@echo "âœ… Go bindings generated successfully"

# æ¸…ç†
clean:
	rm -f $(TARGETS)
	rm -f dns_cache_bpfel.go dns_cache_bpfel.o dns_cache_bpfeb.go dns_cache_bpfeb.o
	rm -f dns_accelerator_bpfel.go dns_accelerator_bpfel.o dns_accelerator_bpfeb.go dns_accelerator_bpfeb.o
	rm -f dns_accelerator_simple_bpfel.go dns_accelerator_simple_bpfel.o dns_accelerator_simple_bpfeb.go dns_accelerator_simple_bpfeb.o
	@echo "ğŸ§¹ Cleaned up build artifacts"

# å®‰è£…ä¾èµ–
deps:
	@echo "ğŸ“¦ Installing dependencies..."
	# å®‰è£…clangå’ŒLLVM
	sudo apt-get update
	sudo apt-get install -y clang llvm make gcc-multilib libc6-dev-i386
	# å®‰è£…Linux headers
	sudo apt-get install -y linux-headers-$(shell uname -r)
	# å®‰è£…libbpfå¼€å‘åŒ…
	sudo apt-get install -y libbpf-dev
	@echo "âœ… Dependencies installed"

# æµ‹è¯•ç¼–è¯‘
test: clean all
	@echo "ğŸ§ª Testing compilation..."
	@if [ -f $(DNS_CACHE_TARGET) ] && [ -f $(DNS_ACCELERATOR_TARGET) ]; then \
		echo "âœ… All DNS eBPF programs compiled successfully"; \
	else \
		echo "âŒ Compilation test failed"; \
		exit 1; \
	fi

# æ£€æŸ¥ç¨‹åºä¿¡æ¯
info:
	@echo "ğŸ“Š eBPF Program Information:"
	@if [ -f $(DNS_CACHE_TARGET) ]; then \
		echo "ğŸ“ DNS Cache Program:"; \
		file $(DNS_CACHE_TARGET); \
		du -h $(DNS_CACHE_TARGET); \
	fi
	@if [ -f $(DNS_ACCELERATOR_TARGET) ]; then \
		echo "ğŸ“ DNS Accelerator Program:"; \
		file $(DNS_ACCELERATOR_TARGET); \
		du -h $(DNS_ACCELERATOR_TARGET); \
	fi

# éªŒè¯eBPFç¨‹åº
verify: $(TARGETS)
	@echo "ğŸ” Verifying eBPF programs..."
	@for target in $(TARGETS); do \
		if command -v bpftool > /dev/null 2>&1; then \
			echo "Verifying $$target..."; \
			bpftool prog load $$target /sys/fs/bpf/test_$$target type xdp 2>/dev/null && \
			bpftool prog delete pinned /sys/fs/bpf/test_$$target 2>/dev/null || true; \
		else \
			echo "âš ï¸  bpftool not available, skipping verification"; \
		fi \
	done
	@echo "âœ… eBPF program verification completed"

# å¼€å‘æ¨¡å¼ - ç›‘æ§æ–‡ä»¶å˜åŒ–å¹¶è‡ªåŠ¨é‡ç¼–è¯‘
dev:
	@echo "ğŸ”§ Development mode - watching for changes..."
	@while true; do \
		inotifywait -q -e modify,create,delete $(DNS_CACHE_SOURCES) $(DNS_ACCELERATOR_SOURCES) 2>/dev/null; \
		echo "ğŸ“ Source file changed, recompiling..."; \
		$(MAKE) clean && $(MAKE) all; \
		echo "âœ… Recompilation completed"; \
	done

# æ€§èƒ½åˆ†æ
profile: $(TARGETS)
	@echo "ğŸ“ˆ Performance analysis:"
	@echo "DNS Cache Program:"
	@objdump -h $(DNS_CACHE_TARGET) | grep -E "(\.text|\.data|\.bss)"
	@echo "DNS Accelerator Program:"  
	@objdump -h $(DNS_ACCELERATOR_TARGET) | grep -E "(\.text|\.data|\.bss)"

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "ğŸ”§ DNS eBPF Makefile Commands:"
	@echo "  all        - Compile all DNS eBPF programs"
	@echo "  clean      - Remove compiled files"
	@echo "  deps       - Install build dependencies"
	@echo "  test       - Test compilation"
	@echo "  info       - Show program information"
	@echo "  verify     - Verify eBPF programs"
	@echo "  generate   - Generate Go bindings"
	@echo "  dev        - Development mode with auto-rebuild"
	@echo "  profile    - Performance analysis"
	@echo "  help       - Show this help message"

# è°ƒè¯•ç‰ˆæœ¬
debug: CFLAGS += -DDEBUG -g3
debug: clean all
	@echo "ğŸ› Debug version compiled with enhanced debugging"

# ä¼˜åŒ–ç‰ˆæœ¬
release: CFLAGS += -DNDEBUG -O3
release: clean all
	@echo "ğŸš€ Release version compiled with optimizations"

# Dockeræ„å»º
docker-build:
	@echo "ğŸ³ Building DNS eBPF in Docker..."
	docker run --rm -v $(PWD):/src -w /src \
		ubuntu:22.04 \
		bash -c "apt-get update && \
				 apt-get install -y clang llvm libbpf-dev && \
				 make clean && make all"
	@echo "âœ… Docker build completed"

# å®‰è£…åˆ°ç³»ç»Ÿ
install: $(TARGETS)
	@echo "ğŸ“¦ Installing DNS eBPF programs..."
	sudo mkdir -p /usr/local/lib/xray/dns/
	sudo cp $(TARGETS) /usr/local/lib/xray/dns/
	sudo chmod 644 /usr/local/lib/xray/dns/*
	@echo "âœ… DNS eBPF programs installed to /usr/local/lib/xray/dns/"

# å¸è½½
uninstall:
	@echo "ğŸ—‘ï¸  Uninstalling DNS eBPF programs..."
	sudo rm -f /usr/local/lib/xray/dns/$(TARGETS)
	@echo "âœ… DNS eBPF programs uninstalled"

.PHONY: all clean deps test info verify generate dev profile help debug release docker-build install uninstall
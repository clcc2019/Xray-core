# Xray Proxy eBPF åŠ é€Ÿå™¨æ„å»º

TARGET_ARCH ?= x86_64
CLANG ?= clang
LLC ?= llc
BPFTOOL ?= bpftool

CFLAGS := -O2 -g -Wall -target bpf -c -fno-stack-protector
INCLUDES := -I/usr/include/bpf -I/usr/include/x86_64-linux-gnu

all: proxy_accelerator.o clean-gen

proxy_accelerator.o: proxy_accelerator.c
	$(CLANG) $(CFLAGS) $(INCLUDES) -o $@ $<
	@echo "âœ… Proxy eBPFç¨‹åºç¼–è¯‘æˆåŠŸ"

clean:
	rm -f *.o
	rm -f *_bpfel.go *_bpfel.o *_bpfeb.go *_bpfeb.o
	@echo "ğŸ§¹ Cleaned up build artifacts"

clean-gen:
	rm -f *_bpfel.go *_bpfel.o *_bpfeb.go *_bpfeb.o

install: proxy_accelerator.o
	@echo "ğŸ“¦ å®‰è£…Proxy eBPFç¨‹åº..."
	sudo mkdir -p /sys/fs/bpf/xray
	
	# åˆ›å»ºproxyä¸“ç”¨Maps
	sudo $(BPFTOOL) map create /sys/fs/bpf/xray/proxy_connections \
		type lru_hash key 8 value 64 entries 16384 name proxy_connections 2>/dev/null || true
	sudo $(BPFTOOL) map create /sys/fs/bpf/xray/tls_sessions \
		type lru_hash key 8 value 96 entries 8192 name tls_sessions 2>/dev/null || true
	sudo $(BPFTOOL) map create /sys/fs/bpf/xray/proxy_stats_map \
		type array key 4 value 64 entries 1 name proxy_stats_map 2>/dev/null || true
	
	# åŠ è½½proxyç¨‹åº
	sudo $(BPFTOOL) prog load proxy_accelerator.o /sys/fs/bpf/xray/proxy_accelerator_xdp \
		type xdp 2>/dev/null && echo "   âœ… Proxy XDPç¨‹åºåŠ è½½æˆåŠŸ" || echo "   âŒ Proxy XDPç¨‹åºåŠ è½½å¤±è´¥"
	sudo $(BPFTOOL) prog load proxy_accelerator.o /sys/fs/bpf/xray/proxy_accelerator_tc \
		type sched_cls 2>/dev/null && echo "   âœ… Proxy TCç¨‹åºåŠ è½½æˆåŠŸ" || echo "   âŒ Proxy TCç¨‹åºåŠ è½½å¤±è´¥"
	
	@echo "ğŸ‰ Proxy eBPFåŠ é€Ÿå™¨å®‰è£…å®Œæˆï¼"

uninstall:
	@echo "ğŸ—‘ï¸  å¸è½½Proxy eBPFç¨‹åº..."
	sudo rm -f /sys/fs/bpf/xray/proxy_accelerator_xdp
	sudo rm -f /sys/fs/bpf/xray/proxy_accelerator_tc
	sudo rm -f /sys/fs/bpf/xray/proxy_connections
	sudo rm -f /sys/fs/bpf/xray/tls_sessions
	sudo rm -f /sys/fs/bpf/xray/proxy_stats_map
	@echo "âœ… Proxy eBPFç¨‹åºå¸è½½å®Œæˆ"

status:
	@echo "ğŸ“Š Proxy eBPFç¨‹åºçŠ¶æ€:"
	@sudo $(BPFTOOL) prog show | grep -E "proxy_accelerator|xray" || echo "   æœªæ‰¾åˆ°å·²åŠ è½½çš„ç¨‹åº"
	@echo ""
	@echo "ğŸ“‹ Proxy eBPF MapsçŠ¶æ€:"
	@sudo $(BPFTOOL) map show | grep -E "proxy|tls" || echo "   æœªæ‰¾åˆ°ç›¸å…³maps"

.PHONY: all clean clean-gen install uninstall status